<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Aspiradores vs Fantasmas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* CRITICAL CSS */
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #0f172a;
        touch-action: none;
        font-family: sans-serif;
      }
      #root {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #loading-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: #0f172a;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      
      .loading-text {
          font-size: 14px;
          color: #94a3b8;
          margin-top: 10px;
          text-align: center;
          font-weight: bold;
          font-family: monospace;
      }

      /* Painel de Debug (Só aparece se DEBUG_BOOT = true) */
      #debug-panel {
        display: none;
        position: fixed;
        bottom: 10px;
        right: 10px;
        width: 300px;
        background: rgba(0, 0, 0, 0.85);
        color: #00ff00;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #333;
        font-family: monospace;
        font-size: 10px;
        z-index: 10000;
        pointer-events: none;
      }
      .debug-step { margin-bottom: 2px; }
      .debug-step.ok { color: #4ade80; }
      .debug-step.pending { color: #facc15; }
      .debug-step.error { color: #f87171; }

      /* Botão de Emergência */
      #force-start-btn {
          display: none;
          margin-top: 25px;
          padding: 12px 24px;
          background-color: #dc2626; /* Vermelho para indicar fallback */
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          z-index: 10001;
      }
    </style>
    <script>
      // ======================================================
      // 1) FLAG GLOBAL DE DEBUG
      // ======================================================
      window.DEBUG_BOOT = true; 
      window.gameIsReady = false;

      // Utilitário de Log
      function bootLog(msg, type = 'info') {
        if (!window.DEBUG_BOOT) return;
        const prefix = "[BOOT DEBUG]";
        if (type === 'error') console.error(prefix, msg);
        else console.log(prefix, msg);
      }

      // Atualiza o painel visual
      window.reportBootStep = function(stepName, status) {
        if (!window.DEBUG_BOOT) return;
        
        const panel = document.getElementById('debug-panel');
        if (panel) {
            panel.style.display = 'block';
            let line = document.getElementById('step-' + stepName);
            if (!line) {
                line = document.createElement('div');
                line.id = 'step-' + stepName;
                line.className = 'debug-step';
                panel.appendChild(line);
            }
            
            let icon = status === 'OK' ? '[✔]' : (status === 'ERROR' ? '[✖]' : '[...]');
            line.innerHTML = `${icon} ${stepName}`;
            line.className = `debug-step ${status.toLowerCase()}`;
        }
        bootLog(`${stepName}: ${status}`);
      };

      // ======================================================
      // 2) FUNÇÃO DE FINALIZAÇÃO (Remove Loader)
      // ======================================================
      window.finishLoading = function() {
        if (window.gameIsReady) return;
        window.gameIsReady = true;
        
        window.reportBootStep('Remove Loader', 'OK');
        
        const loader = document.getElementById('loading-overlay');
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
            }, 500);
        }
      };

      // ======================================================
      // 3) LISTENER DE ERROS GLOBAIS
      // ======================================================
      window.onerror = function(msg, url, line, col, error) {
        if (msg && typeof msg === 'string' && msg.includes('ResizeObserver')) return false;
        
        bootLog(`Erro Global Detectado: ${msg}`, 'error');
        window.reportBootStep('Global JS', 'ERROR');
        
        const statusEl = document.getElementById('loading-status');
        if (statusEl) statusEl.innerText = "Erro no boot. Tentando recuperar...";
        
        // Em caso de erro, força a entrada após 2s para não travar o usuário
        setTimeout(() => window.finishLoading(), 2000);
        return false;
      };

      document.addEventListener("DOMContentLoaded", function() {
          window.reportBootStep('DOM Content Loaded', 'OK');
          
          const root = document.getElementById('root');
          
          // Fallback de Polling (Caso o React monte mas esqueça de avisar)
          let pollCount = 0;
          const checkInterval = setInterval(() => {
              pollCount++;
              if (root && root.childElementCount > 0) {
                  window.reportBootStep('React Mount Detected (Polling)', 'OK');
                  clearInterval(checkInterval);
                  window.finishLoading();
              }
              // Se passar 20 segundos (100 * 200ms) e nada...
              if (pollCount > 100 && !window.gameIsReady) {
                  const btn = document.getElementById('force-start-btn');
                  if (btn) btn.style.display = 'block';
                  document.getElementById('loading-status').innerText = "O jogo está demorando. Tente iniciar manualmente.";
              }
          }, 200);
          
          // Handler do botão de emergência
          const btn = document.getElementById('force-start-btn');
          if(btn) btn.onclick = function() {
              bootLog("Force Start acionado pelo usuário");
              window.finishLoading();
          };
      });
    </script>
    <script type="importmap">
    {
      "imports": {
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
      }
    }
    </script>
  </head>
  <body>
    <!-- Overlay de Loading -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2 style="font-weight:bold; font-size: 20px; margin-bottom: 5px;">Aspiradores vs Fantasmas</h2>
        <p id="loading-status" class="loading-text">Inicializando sistema...</p>
        <button id="force-start-btn">ENTRAR NO JOGO (DEBUG)</button>
    </div>

    <!-- Painel de Debug (Overlay) -->
    <div id="debug-panel">
        <div style="border-bottom:1px solid #333; margin-bottom:5px; font-weight:bold;">BOOT DEBUG MODE</div>
        <!-- Steps serão inseridos aqui via JS -->
    </div>

    <div id="root"></div>
  </body>
</html>